<!DOCTYPE html>
<html>
    <head>
        <title>WebVAD - Spracherkennung im Browser</title>
        <style>
            audio { display: block; }
        </style>
        <script src="./js/ort.1.14.0.js"></script>
        <script src="./js/vad-web.0.0.22.js"></script>
        <script type="module">

            import UTILS from './js/utils.mjs'
            import TASKBRIDGE from './js/taskbridge.js'

            // http://192.168.0.152:42000/taskbridge.js

            const infoTag = document.getElementById('info')
            const outputTag = document.getElementById('output')

            let vadInstance

            async function init() {
                vadInstance = await vad.MicVAD.new({

                    baseAssetPath: './assets/',
                    onnxWASMBasePath: './assets/',
                    positiveSpeechThreshold: .5, // .5
                    negativeSpeechThreshold: .35, // .35

                    onSpeechStart: () => {
                        infoTag.innerHTML = 'Sprache erkannt, warte auf Pause'
                    },

                    onSpeechEnd: async (audio) => {
                        infoTag.innerHTML = 'Pause erkannt, verarbeite Sprache'
                        const wavBuffer = UTILS.encodeWav(audio)
                        const base64 = UTILS.arrayBufferToBase64(wavBuffer)
                        const blob = new Blob([wavBuffer], { type: 'audio/wav' })
                        const url = `data:audio/wav;base64,${base64}`
                        const partTag = document.createElement('div')
                        const audioTag = document.createElement('audio')
                        audioTag.controls = true
                        audioTag.src = url
                        partTag.appendChild(audioTag)
                        const textTag = document.createElement('div')
                        textTag.innerHTML = 'Warte auf Transkription ...'
                        partTag.appendChild(textTag)
                        outputTag.appendChild(partTag)

                        var addTranscriptionResult = await TASKBRIDGE.addTask('transcribe', undefined, blob)
                        const transcriptionTaskId = addTranscriptionResult.id
                        TASKBRIDGE.waitForTaskCompletion(transcriptionTaskId, undefined, async (transcriptionTaskResult) => {
                            if (transcriptionTaskResult) {
                                console.log(transcriptionTaskResult)
                                const texts = transcriptionTaskResult.texts.map(t => t.text)
                                textTag.innerHTML = texts.join(" ")
                                if (transcriptionTaskResult.language != 'de') {
                                    var addTranslationResult = await TASKBRIDGE.addTask('translate', { sourcelanguage: transcriptionTaskResult.language, targetlanguage: 'de', texts: texts })
                                    const translationTaskId = addTranslationResult.id
                                    TASKBRIDGE.waitForTaskCompletion(translationTaskId, undefined, async (translationTaskResult) => {
                                        if (translationTaskResult) {
                                            console.log(translationTaskResult)
                                            textTag.innerHTML += '<br/>' + translationTaskResult.texts.map(e => e.text).join(" ")
                                        }
                                    })
                                }
                            }
                        })

                        document.body.scrollTop = document.body.scrollHeight;

                        infoTag.innerHTML = 'Aktiv, warte auf Sprache'
                    }

                })

                document.getElementById('startButton').addEventListener('click', start)
                document.getElementById('stopButton').addEventListener('click', stop)
            }

            function start() {
                vadInstance.start()
                infoTag.innerHTML = 'Aktiv, warte auf Sprache'
            }

            function stop() {
                vadInstance.pause()
                infoTag.innerHTML = 'Inaktiv'
            }

            init()

        </script>
    </head>

    <body>

        <h1>Steuerung</h1>

        <button id="startButton">Start</button>
        <button id="stopButton">Stop</button>

        <div id="info">Inaktiv</div>

        <h2>Ausgabe</h2>

        <div id="output"></div>

    </body>

</html>